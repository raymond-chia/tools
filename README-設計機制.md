- 重要元素: 位置（光、掩體、高地命中、夾擊、line of sight）、位移（製造地形、利用地形、元素反應）、反應動作、壓力機制、fog of war

# Game Design Document (GDD)

> **狀態**：草稿 v0.1
> **開發者**：單人開發
> **技術棧**：Rust + Godot, Data-Driven, ECS, TDD
> **預計遊玩時間**：20 小時

---

## 1. 核心願景

### 一句話描述

回合制戰棋，強調**戰前規劃與戰術驗證**——玩家透過地形、技能組合與角色配置設計戰術，在戰場上逐步執行並驗證其有效性。

### 核心樂趣

- 規劃戰術 → 嘗試執行 → 發現穩定成功時的成就感
- 適度隨機性防止最優解（骰子判定），但敵人配置固定以利戰術設計
- 根據偏好戰術培養角色，不同角色學習不同技能以合作完成戰術

### 設計參考

- _Pathfinder: Wrath of the Righteous — Through the Ashes DLC_：利用地形與機關對付敵人，針對性培養角色

---

## 2. 戰場系統

### 2.1 格子

| 項目 | 規則                          |
| ---- | ----------------------------- |
| 形狀 | 正方形格子                    |
| 距離 | 曼哈頓距離（上下左右 4 方向） |
| 高度 | 無                            |

### 2.2 光照

格子有三種光照狀態：

| 光照 | 命中/閃避 | Line of Sight |
| ---- | --------- | ------------- |
| 明亮 | 正常      | 正常          |
| 昏暗 | 降低      | 正常          |
| 黑暗 | 降低      | 切斷          |

- 擁有**夜視**的單位在昏暗中免除減益
- 擁有**聽覺定位**的單位在昏暗、黑暗中免除減益，且可在黑暗中單體攻擊

> **TODO**：定義昏暗/黑暗的具體命中/閃避減值

### 2.3 感知系統

兩套獨立的感知系統，判定邏輯相同但被不同地圖物件阻擋：

| 感知類型 | 判定方式              | 阻擋來源           |
| -------- | --------------------- | ------------------ |
| 視線     | Bresenham 直線 + 距離 | 阻擋視線的地圖物件 |
| 聽覺     | Bresenham 直線 + 距離 | 阻擋聲音的地圖物件 |

規則：

- 沒有地圖迷霧，黑暗中仍可看到敵人位置（UI 層面可見）
- 單體攻擊需要感知到目標（視線或聽覺）
- 不以單位為目標的範圍技能可施放到無法感知的格子

### 2.4 地圖物件

地圖物件的屬性標籤（可組合）：

| 標籤     | 效果                               |
| -------- | ---------------------------------- |
| 即死     | 單位進入或被推入時直接死亡，無檢定 |
| 阻止通過 | 單位無法進入該格                   |
| 阻擋視線 | 切斷視線感知                       |
| 阻擋聲音 | 切斷聽覺感知                       |

> **TODO**：列出具體地圖物件清單（懸崖、牆壁、水池…）

---

## 3. 行動機制

### 3.1 回合結構

每輪開始時，所有單位依 `INI + 隨機骰` 決定行動順序。

回合流程：

1. **回合開始**：檢查該單位身上的效果，過期（TTL=0）的移除
2. **行動**（見下方）
3. **回合結束**：觸發該單位身上的持續效果（DoT 等）→ 扣除該單位身上效果的 TTL

**效果歸屬與時效**：效果的 TTL 扣除和過期檢查都綁在**效果持有者**的回合，與施加者無關。

**Buff / Debuff 生效時機**：施放後立即生效，計算屬性時直接納入現有 buff/debuff。

### 3.2 行動選項

每個單位的回合可選擇以下其一：

| 模式        | 說明                         |
| ----------- | ---------------------------- |
| 移動 + 移動 | 移動距離 = 2 × MOV           |
| 移動 + 技能 | 先移動再使用技能（順序固定） |
| 僅技能      | 不移動，直接使用技能         |

- 使用技能後**不能**再移動或使用其他技能（除非技能特別標註可以）
- 移動中可走任意路徑，只要不超過 MOV
- 可穿越友軍，不可穿越敵軍或阻止通過的物件
- 不可停在其他單位的格子上

### 3.3 延後行動

- 尚未行動的單位可延後到該輪任意位置
- 延後會順帶延後回合效果

---

## 4. 判定系統

### 4.1 單體攻擊（命中判定）

```
判定值 = 攻擊者命中 + 技能命中 + 1d100
```

**硬性規則**：

- 1d100 > 95 → 強制命中（閃避失敗、格擋失敗）
- 1d100 < 5 → 強制閃避成功

| 判定結果 | 條件                        | 傷害               | 命中效果 |
| -------- | --------------------------- | ------------------ | -------- |
| 閃避     | 判定值 < 敵人閃避           | 無                 | 無       |
| 格擋     | 閃避 ≤ 判定值 < 閃避 + 格擋 | × (1 - 格擋保護值) | 變弱     |
| 命中     | 判定值 ≥ 閃避 + 格擋        | 全額               | 正常     |

**暴擊**：若 1d100 > (100 - 暴擊率)，傷害 ×2（格擋後的最終傷害也 ×2），命中效果不變。暴擊與命中/格擋獨立判定，同一次骰子。

**效果變弱規則**：

- 傷害類：傷害減半（全局統一）
- Debuff 類：由各技能自行定義弱化版效果（技能資料中的 `weakened_effect` 欄位）

### 4.2 範圍攻擊（豁免判定）

```
攻擊端 = 攻擊者 DC + 技能 DC
防禦端 = 目標豁免（強韌/反射/意志）+ 1d100
```

| 結果         | 傷害 | 效果 |
| ------------ | ---- | ---- |
| 目標檢定失敗 | 全額 | 正常 |
| 目標檢定成功 | 減半 | 變弱 |

範圍技能**會影響友方單位**（友軍同樣進行豁免判定）。

### 4.3 位移與即死

- 位移技能可將單位推入即死位置
- 被推入即死位置 → 直接死亡，無任何檢定

---

## 5. 角色系統

### 5.1 屬性一覽

| 屬性              | 說明                     |
| ----------------- | ------------------------ |
| HP                | 生命值                   |
| MP                | 法力值                   |
| INI               | 先攻（加隨機骰決定順序） |
| 命中              | 單體攻擊判定加值         |
| 閃避              | 被攻擊時的閃避門檻       |
| 格擋              | 閃避之上的額外防禦門檻   |
| 格擋保護值        | 格擋時的傷害減免比例     |
| 物理攻擊力        | 物理傷害基礎值           |
| 魔法攻擊力        | 魔法傷害基礎值           |
| 魔法檢定難度 (DC) | 範圍技能的 DC 加值       |
| 強韌              | 對抗強韌豁免             |
| 反射              | 對抗反射豁免             |
| 意志              | 對抗意志豁免             |
| MOV               | 移動距離                 |
| 反應次數          | 每輪可觸發的反應次數     |

- 命中、閃避、格擋**無上限**
- 所有屬性由**被動技能與狀態**加總獲得（角色本身無基礎數值）

### 5.2 反應系統

單位在自身回合外可觸發反應，每輪消耗反應次數。目前定義兩種反應：

| 反應類型   | 觸發條件                             | 效果                 |
| ---------- | ------------------------------------ | -------------------- |
| 藉機攻擊   | 敵方單位**主動移動**離開本單位相鄰格 | 對該單位發動一次攻擊 |
| 被攻擊反應 | 本單位被攻擊時                       | 依反應技能而定       |

> 反應類型可在 playtesting 後擴充。

### 5.2 成長方式（暫定）

- 不透過升級獲得數值成長
- 學習更多技能 + 更換更高數值的裝備

> **TODO**：確認成長系統細節

---

## 6. 技能系統

- 技能無冷卻時間
- 部分技能消耗 MP
- 技能分類：攻擊、位移、增益、控制…

> **TODO**：設計具體技能清單

---

## 7. 關卡設計

### 7.1 結構

- 小隊冒險，隨故事進展最終達到**六人小隊**
- 敵人配置固定（不隨機生成），以利玩家設計戰術

### 7.2 勝利/失敗條件

| 類型 | 範例                                                                                           |
| ---- | ---------------------------------------------------------------------------------------------- |
| 勝利 | 消滅所有敵人、消滅關鍵敵人、存活指定回合、到達指定地點、護送目標指定回合、護送目標到達指定地點 |
| 失敗 | 隊伍全滅、關鍵敵人逃離、被護送目標死亡                                                         |

> **TODO**：規劃關卡流程與數量（預計 20 hr 遊玩時間）

---

## 8. 未決事項 (TODO)

| 項目             | 優先度 | 備註                         |
| ---------------- | ------ | ---------------------------- |
| 技能設計         | 高     | 核心玩法依賴技能組合         |
| 反應技能設計     | 高     | 被攻擊反應的具體技能需要定義 |
| 光照減值具體數字 | 中     | 影響平衡，放 balance sheet   |
| 成長系統細節     | 中     | 升級 vs 純裝備+技能          |
| 地圖物件清單     | 中     | 影響關卡設計                 |
| 關卡流程規劃     | 中     | 配合 20hr 遊玩時間           |
| 敘事/世界觀      | 低     | 可後期補充                   |

## 優先度低

- 大地圖隱匿與被偵測機制，被偵測 (敵人 8 格內 & 在敵人 line of sight 或者聽覺定位範圍內) 到就開戰

## 優先度低，先不做

- tech
  - 根據敵我的偵測與隱匿檢定差距，決定多遠可以偵測到隱匿單位（偵測 vs 隱匿被動加值每差 2 可以早一格偵測到）
    - 沒有特殊地形的話，就算偵測很低也能偵測到旁邊一格，就算偵測很高也只能偵測到 12 格內
    - 如果偵測跟隱匿加值相同（比如都升級到最高），則偵測範圍是 4 格
    - 每次升級可以用技巧點數提升偵測或隱匿（或者其他 tech）
      - tech 都是在比大小（無論是跟環境比還是跟其他單位比）
      - skill 是增加技能，比如產生冰柱、煙霧彈、火焰攻擊等等
  - 如果冰柱/煙霧消失（被打壞、過期）且後面的單位在對手 line of sight 內 & 偵測範圍內，會解除隱匿
  - 隱匿可以避開部分敵人; 可以在開戰前佔據有利位置
    - 隱匿時命中有優勢（roll 1d100 with adv）（骰到暴擊的機率也會因此上升）
    - 攻擊後如果在敵人 los 內，會解除隱匿（所以只有切斷 los 的情況下靠 AoE 可以在攻擊敵人後維持隱匿）
      - AoE 目標點必須在自己的 los，但是攻擊覆蓋範圍的其他點不需要在 los
    - 在敵人 12 格內使用技能，會讓敵人知道單位在哪一格
      - skill 最遠 12 格
    - 開打後不容易再次隱匿（需要切斷 los，並使用隱匿技能）
